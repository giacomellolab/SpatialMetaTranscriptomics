---
title: "lableaf_analysis_paper"
author: "Sami Saarenpää"
date: "9/25/2021"
output: html_document
---
# Laod the packages
```{r}
suppressPackageStartupMessages({
  library(STutility)
  library(Seurat)
  library(harmony)
  library(gridExtra)
  library(pals)
  library(akima)
  library(readr)
  library(plotly)
  library(tibble)
  library(raster)
  library(dplyr)
  library(stringr)
  library(magrittr)
  library(ggplot2)
  library(imager)
  library(Matrix)
  library(cowplot)
  require(data.table)
  library(magick)
  library(grid)
  library(SeuratObject)
  library(harmony)
  library(RColorBrewer)
  library(gprofiler2)
  library(spdep)
})
```


#Infotable & load the data
```{r, fig.width = 22, fig.height=18}

samples <- list.files(path = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/data/Arabidopsis_counts", pattern = ".tsv", recursive = FALSE, full.names = T)


imgs <- list.files(path = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/imgs/", pattern = ".jpg", recursive = FALSE, full.names = T)

spotfiles <- list.files(path = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/imgs/", pattern = ".tsv", recursive = FALSE, full.names = T)

sample_id = c("100pT_A1", "100pT_A2", "10016S_B1", "10016S_B2", "50pt-5016S_C1", "50pt-5016S_C2", "10pt-4516S-45ITS_D1", "10pt-4516S-45ITS_D2")
leaf = c("P7.C1","P7.C6","P7.C1","P7.C6","P7.C1","P7.C6","P7.C1","P7.C6")
probe = c("100pT", "100pT", "100-16S", "100-16S", "50pT--50-16S", "50pT--50-16S", "10pT--45-16S--45-ITS","10pT--45-16S--45-ITS")

scaleVisium <- c(1,1,1,1,1,1,1,1)

infoTable <- data.frame(samples, 
                        spotfiles, 
                        imgs, 
                        scaleVisium, 
                        sample_id,
                        leaf = c("P7.C1","P7.C6","P7.C1","P7.C6","P7.C1","P7.C6","P7.C1","P7.C6"),
                        probe = c("100pT", "100pT", "100-16S", "100-16S", "50pT--50-16S", "50pT--50-16S", "10pT--45-16S--45-ITS","10pT--45-16S--45-ITS"), 
                        stringsAsFactors = F)

lableaf062 <- InputFromTable(infotable = infoTable, 
                                 transpose = F, 
                                 platform = "Visium") 

lableaf062_filtered <- InputFromTable(infotable = infoTable, 
                                 transpose = F, 
                                 platform = "Visium", 
                                 minUMICountsPerGene = 30,
                                 minUMICountsPerSpot = 10,
                                 minSpotsPerGene = 20,
                                 minGenesPerSpot = 10)


```
#Mitochondrial, ribosomal, chloroplast and non-coding genes
```{r, fig.width = 22, fig.height=18}

  mt.genes<- grep(pattern = "^ATM", x = rownames(lableaf062), value = TRUE)
  lableaf062$percent.mito <- (Matrix::colSums(lableaf062@assays$RNA@counts[mt.genes, ])/Matrix::colSums(lableaf062@assays$RNA@counts))*100
  chloro.genes <- grep(pattern = "^ATC", x = rownames(lableaf062), value = TRUE)
  lableaf062$percent.chloro <- (Matrix::colSums(lableaf062@assays$RNA@counts[chloro.genes, ])/Matrix::colSums(lableaf062@assays$RNA@counts))*100
  rb.Genes <- as.list(c("AT1G72370", "AT3G04770", "AT1G58380", "AT1G59359", "AT2G41840", "AT3G57490", "AT1G58684", "AT1G58983", "AT2G31610", "AT3G53870", "AT5G35530", "AT3G04840", "AT4G34670", "AT2G17360", "AT5G07090", "AT5G58420", "AT2G37270", "AT3G11940", "AT4G31700", "AT5G10360", "AT1G48830", "AT3G02560", "AT5G16130", "AT5G20290", "AT5G59240", "AT4G12160", "AT5G15200", "AT5G39850", "AT4G25740", "AT5G41520", "AT5G52650", "AT3G48930", "AT4G30800", "AT5G23740", "AT1G15930", "AT1G80800", "AT2G32060", "AT3G60770", "AT4G00100", "AT2G36160", "AT3G11510", "AT3G52580", "AT1G04270", "AT5G09490", "AT5G09500", "AT5G09510", "AT5G43640", "AT5G63070", "AT1G07770", "AT2G19720", "AT2G39590", "AT3G46040", "AT4G29430", "AT5G59850", "AT2G09990", "AT3G04230", "AT5G18380", "AT2G04390", "AT2G05220", "AT3G10610", "AT5G04800", "AT1G22780", "AT1G34030", "AT4G09800", "AT3G02080", "AT5G15520", "AT5G61170", "AT3G45030", "AT3G47370", "AT5G62300", "AT3G27450", "AT3G53890", "AT5G27700", "AT3G09680", "AT5G02960", "AT3G04920", "AT5G28060", "AT2G16360", "AT2G21580", "AT3G30740", "AT4G34555", "AT4G39200", "AT2G40510", "AT2G40590", "AT3G56340", "AT2G45710", "AT3G61110", "AT5G47930", "AT1G23410", "AT2G47100", "AT3G62250", "AT3G10090", "AT5G03850", "AT5G64140", "AT3G43980", "AT3G44010", "AT4G33865", "AT2G19750", "AT4G29390", "AT5G56670", "AT2G40010", "AT3G09200", "AT3G11250", "AT1G01100", "AT4G00810", "AT5G47700", "AT5G24510", "AT3G49460", "AT2G27720", "AT2G27710", "AT3G28500", "AT3G44590", "AT5G40040", "AT4G25890", "AT5G57290", "AT1G43170", "AT1G61580", "AT5G42445", "AT3G09630", "AT1G35200", "AT2G24730", "AT5G02870", "AT3G25520", "AT5G39740", "AT5G40130", "AT1G18540", "AT1G74060", "AT1G74050", "AT1G80750", "AT2G01250", "AT2G44120", "AT3G13580", "AT2G47610", "AT3G62870", "AT2G18020", "AT3G51190", "AT4G36130", "AT1G33120", "AT1G33140", "AT4G10450", "AT1G14320", "AT1G26910", "AT1G66580", "AT1G08360", "AT2G27530", "AT5G22440", "AT2G42740", "AT3G58700", "AT4G18730", "AT5G45775", "AT2G37190", "AT3G53430", "AT5G60670", "AT3G48130", "AT3G49010", "AT3G48960", "AT5G23900", "AT3G07110", "AT3G24830", "AT4G13170", "AT5G48760", "AT2G20450", "AT4G27090", "AT4G16720", "AT4G17390", "AT1G27400", "AT1G67430", "AT2G47570", "AT3G05590", "AT5G27850", "AT1G29970", "AT2G34480", "AT3G14600", "AT1G02780", "AT3G16780", "AT4G02230", "AT1G09590", "AT1G09486", "AT1G09690", "AT1G31355", "AT1G57660", "AT3G57820", "AT1G57860", "AT1G02830", "AT3G05560", "AT5G27770", "AT1G04480", "AT2G33370", "AT3G04400", "AT2G39460", "AT3G55280", "AT2G36620", "AT3G53020", "AT2G44860", "AT3G49910", "AT5G67510", "AT2G32220", "AT3G22230", "AT4G15000", "AT1G12960", "AT1G23290", "AT1G70600", "AT2G19730", "AT3G06700", "AT3G06680", "AT1G36240", "AT1G77940", "AT3G18740", "AT2G19740", "AT4G26230", "AT5G56710", "AT4G18100", "AT5G46430", "AT1G26880", "AT1G69620", "AT3G28900", "AT3G09500", "AT2G39390", "AT3G55170", "AT5G02610", "AT1G07070", "AT1G41880", "AT1G74270", "AT3G55750", "AT2G37600", "AT3G53740", "AT5G02450", "AT3G23390", "AT4G14320", "AT1G15250", "AT1G52300", "AT3G16080", "AT2G35180", "AT3G10950", "AT3G60245", "AT2G43460", "AT3G59540", "AT2G25210", "AT3G02190", "AT4G31985", "AT2G36170", "AT3G52590", "AT1G56045", "AT3G08520", "AT3G11120", "AT3G56020"))
  Araport11_rRNA.201606 <- read.table("/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/Araport11_rRNA.201606.ID", quote="\"", comment.char="")
  Araport11_rRNA.201606 <- as.list(Araport11_rRNA.201606$V1)
  rb.Genes <- as.character(append(rb.Genes,Araport11_rRNA.201606))

  lableaf062$percent.ribo <- (Matrix::colSums(lableaf062@assays$RNA@counts[(intersect(rownames(lableaf062), rb.Genes)), ])/Matrix::colSums(lableaf062@assays$RNA@counts))*100
   
  noncoding.genes <-  read.table("/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/Araport11_non_coding.201606.ID", quote="\"", comment.char="")
  noncoding.genes <- as.character(noncoding.genes$V1)
   lableaf062$noncoding.genes <- (Matrix::colSums(lableaf062@assays$RNA@counts[(intersect(rownames(lableaf062), noncoding.genes)), ])/Matrix::colSums(lableaf062@assays$RNA@counts))*100
```

#Bacteria
```{r}
bacteria <- list.files(path = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/bacteria_210615", pattern = "usearch_unique_vs_NT_Jan2021.UMI_filtered.genus.spatial_pos.txt", recursive = FALSE, full.names = T)
OMNI06_bacteria <- c()
for (i in 1:length(bacteria)){
  OMNI06_bacteria[[i]] <- read.csv(bacteria[[i]], row.names=1, sep=";", header = F)
}


colnames(OMNI06_bacteria[[1]]) <-lapply(lapply(OMNI06_bacteria[[1]][1,], function(x) paste(x,'_1')), function(x) str_remove(x, " "))
colnames(OMNI06_bacteria[[2]]) <-lapply(lapply(OMNI06_bacteria[[2]][1,], function(x) paste(x,'_2')), function(x) str_remove(x, " "))
colnames(OMNI06_bacteria[[3]]) <-lapply(lapply(OMNI06_bacteria[[3]][1,], function(x) paste(x,'_3')), function(x) str_remove(x, " "))
colnames(OMNI06_bacteria[[4]]) <-lapply(lapply(OMNI06_bacteria[[4]][1,], function(x) paste(x,'_4')), function(x) str_remove(x, " "))
colnames(OMNI06_bacteria[[5]]) <-lapply(lapply(OMNI06_bacteria[[5]][1,], function(x) paste(x,'_5')), function(x) str_remove(x, " "))
colnames(OMNI06_bacteria[[6]]) <-lapply(lapply(OMNI06_bacteria[[6]][1,], function(x) paste(x,'_6')), function(x) str_remove(x, " "))
colnames(OMNI06_bacteria[[7]]) <-lapply(lapply(OMNI06_bacteria[[7]][1,], function(x) paste(x,'_7')), function(x) str_remove(x, " "))
colnames(OMNI06_bacteria[[8]]) <-lapply(lapply(OMNI06_bacteria[[8]][1,], function(x) paste(x,'_8')), function(x) str_remove(x, " "))

for (i in  1:length(OMNI06_bacteria)){
  
  OMNI06_bacteria[[i]] <- OMNI06_bacteria[[i]][-1,]
}



brns <- unique(unlist(lapply(OMNI06_bacteria, rownames)))
bcns <- colnames(lableaf062)
bac_df <- data.frame(matrix(0, nrow = length(brns), ncol = length(bcns)))
rownames(bac_df) <- brns
colnames(bac_df) <- bcns
 for (i in c(1:length(OMNI06_bacteria))){
  bac_df[rownames(OMNI06_bacteria[[i]]), colnames(OMNI06_bacteria[[i]])] = OMNI06_bacteria[[i]]
}
rmoves <- setdiff(colnames(bac_df), colnames(lableaf062))
bac_df_filt <- bac_df[ , -which(names(bac_df) %in% rmoves)]
bac_df_filt[is.na(bac_df_filt)]<- 0
lableaf062[['BACTERIA']] <- CreateAssayObject(counts = bac_df_filt)
DefaultAssay(lableaf062) <- "BACTERIA"

#saveRDS(lableaf062, "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210925_lableaf062.plant_bacteria.rds")
#lableaf062 <- readRDS("/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210925_lableaf062.plant_bacteria.rds")
```
#Summed counts on different data modalities
```{r}
lableaf062$nCount_RNABAC <- lableaf062[["nCount_RNA"]] + lableaf062[["nCount_BACTERIA"]]
lableaf062$nFeature_RNABAC <- lableaf062[["nFeature_RNA"]] + lableaf062[["nFeature_BACTERIA"]]
```

##Stats
```{r, fig.width = 30, fig.height=15}
d0 <- VlnPlot(lableaf062, features = "nCount_RNA", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d2 <- VlnPlot(lableaf062, features = "nFeature_RNA", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d3<- VlnPlot(lableaf062, features = "percent.mito", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d4 <- VlnPlot(lableaf062, features = "percent.chloro", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d5 <- VlnPlot(lableaf062, features = "percent.ribo", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d6 <- VlnPlot(lableaf062, features = "nCount_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d7 <- VlnPlot(lableaf062, features = "nFeature_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d8 <- VlnPlot(lableaf062, features = "nCount_RNABAC", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d9 <- VlnPlot(lableaf062, features = "nFeature_RNABAC", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")

pdf(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210925_lableaf_stats_bySample.pdf", width = 18, height = 15, useDingbats = F)
plot <- plot_grid(d0,d2,d3,d4,d5,d6,d7,d8,d9, nrow = 3)
print(plot)
dev.off()

d0 <- VlnPlot(lableaf062, features = "nCount_RNA", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d2<- VlnPlot(lableaf062, features = "nFeature_RNA", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d3 <- VlnPlot(lableaf062, features = "percent.mito", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d4 <- VlnPlot(lableaf062, features = "percent.chloro", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d5 <- VlnPlot(lableaf062, features = "percent.ribo", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d6 <- VlnPlot(lableaf062, features = "nCount_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d7 <- VlnPlot(lableaf062, features = "nFeature_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d8 <- VlnPlot(lableaf062, features = "nCount_RNABAC", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d9 <- VlnPlot(lableaf062, features = "nFeature_RNABAC", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")

pdf(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210925_lableaf_stats_byLeaf.pdf", width = 18, height = 15, useDingbats = F)
plot <- plot_grid(d0,d2,d3,d4,d5,d6,d7,d8,d9, nrow = 3)
print(plot)
dev.off()

d0 <- VlnPlot(lableaf062, features = "nCount_RNA", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d2 <- VlnPlot(lableaf062, features = "nFeature_RNA", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d3 <- VlnPlot(lableaf062, features = "percent.mito", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d4 <- VlnPlot(lableaf062, features = "percent.chloro", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d5 <- VlnPlot(lableaf062, features = "percent.ribo", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d6 <- VlnPlot(lableaf062, features = "nCount_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d7 <- VlnPlot(lableaf062, features = "nFeature_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d8 <- VlnPlot(lableaf062, features = "nCount_RNABAC", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d9 <- VlnPlot(lableaf062, features = "nFeature_RNABAC", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")

pdf(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210925_lableaf_stats_byProbe.pdf", width = 18, height = 15, useDingbats = F)
plot <- plot_grid(d0,d2,d3,d4,d5,d6,d7,d8,d9, nrow = 3)
print(plot)
dev.off()

```

##Filter low number spots and genes
```{r, fig.width= 8, fig.height=20}

cat("Number of spots after subsetting filter:", ncol(lableaf062), "\n")
DefaultAssay(lableaf062) <- "RNA"
cat("Number of host genes before subsetting filter:", nrow(lableaf062), "\n")
DefaultAssay(lableaf062) <- "BACTERIA"
cat("Number of bacterial genes before subsetting filter:", nrow(lableaf062), "\n")


lableaf062 <- SubsetSTData(lableaf062, expression = nCount_RNABAC >= 30)
lableaf062 <- SubsetSTData(lableaf062, expression = nFeature_RNABAC >= 10)

RNA_data<-GetAssayData(lableaf062, assay = "RNA")
#RNA_data[RNA_data  <= 1] <- 0 
RNA_data<- RNA_data[rowSums(RNA_data != 0) >0, ]
lableaf062[['RNA']] <- CreateAssayObject(counts = RNA_data)

BAC_data<-GetAssayData(lableaf062, assay = "BACTERIA")
#BAC_data[BAC_data  <= 1] <- 0 
BAC_data<- BAC_data[rowSums(BAC_data != 0) >0, ]
lableaf062[['BACTERIA']] <- CreateAssayObject(counts = BAC_data)

cat("Number of spots after subsetting filter:", ncol(lableaf062), "\n")
DefaultAssay(lableaf062) <- "RNA"
cat("Number of host genes before subsetting filter:", nrow(lableaf062), "\n")
DefaultAssay(lableaf062) <- "BACTERIA"
cat("Number of bacterial genes before subsetting filter:", nrow(lableaf062), "\n")
```

##Stats
```{r, fig.width = 30, fig.height=15}
d0 <- VlnPlot(lableaf062, features = "nCount_RNA", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d2 <- VlnPlot(lableaf062, features = "nFeature_RNA", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d3<- VlnPlot(lableaf062, features = "percent.mito", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d4 <- VlnPlot(lableaf062, features = "percent.chloro", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d5 <- VlnPlot(lableaf062, features = "percent.ribo", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d6 <- VlnPlot(lableaf062, features = "nCount_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d7 <- VlnPlot(lableaf062, features = "nFeature_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d8 <- VlnPlot(lableaf062, features = "nCount_RNABAC", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d9 <- VlnPlot(lableaf062, features = "nFeature_RNABAC", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")

pdf(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210925_lableaf_stats_bySample_filter.pdf", width = 18, height = 15, useDingbats = F)
plot <- plot_grid(d0,d2,d3,d4,d5,d6,d7,d8,d9, nrow = 3)
print(plot)
dev.off()

d0 <- VlnPlot(lableaf062, features = "nCount_RNA", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d2<- VlnPlot(lableaf062, features = "nFeature_RNA", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d3 <- VlnPlot(lableaf062, features = "percent.mito", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d4 <- VlnPlot(lableaf062, features = "percent.chloro", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d5 <- VlnPlot(lableaf062, features = "percent.ribo", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d6 <- VlnPlot(lableaf062, features = "nCount_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d7 <- VlnPlot(lableaf062, features = "nFeature_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d8 <- VlnPlot(lableaf062, features = "nCount_RNABAC", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")
d9 <- VlnPlot(lableaf062, features = "nFeature_RNABAC", ncol = 1, pt.size = 0.005, group.by = "leaf") + xlab("Leaf")

pdf(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210925_lableaf_stats_byLeaf_filter.pdf", width = 18, height = 15, useDingbats = F)
plot <- plot_grid(d0,d2,d3,d4,d5,d6,d7,d8,d9, nrow = 3)
print(plot)
dev.off()

d0 <- VlnPlot(lableaf062, features = "nCount_RNA", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d2 <- VlnPlot(lableaf062, features = "nFeature_RNA", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d3 <- VlnPlot(lableaf062, features = "percent.mito", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d4 <- VlnPlot(lableaf062, features = "percent.chloro", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d5 <- VlnPlot(lableaf062, features = "percent.ribo", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d6 <- VlnPlot(lableaf062, features = "nCount_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d7 <- VlnPlot(lableaf062, features = "nFeature_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d8 <- VlnPlot(lableaf062, features = "nCount_RNABAC", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")
d9 <- VlnPlot(lableaf062, features = "nFeature_RNABAC", ncol = 1, pt.size = 0.005, group.by = "probe") + xlab("Probe")

pdf(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210925_lableaf_stats_byProbe_filter.pdf", width = 18, height = 15, useDingbats = F)
plot <- plot_grid(d0,d2,d3,d4,d5,d6,d7,d8,d9, nrow = 3)
print(plot)
dev.off()

```
#Visualisation
##Load images
```{r}
lableaf062 <- LoadImages(lableaf062, time.resolve = F)

```
##Opacity change
```{r, fig.width= 16, fig.height=13}
st.object <- GetStaffli(lableaf062) # Colect Staffli object from Seurat object

# following part will modify the "raw" images
# If you want to change the opacity for "masked" or "processed" images you will need to specify this
st.object@rasterlists$raw <- lapply(st.object@rasterlists$raw, function(im) {
  im <- apply(im, 2, function(x) {
    scales::alpha(x, alpha = 0.8)
  })
  return(im)
})
lableaf062@tools$Staffli <- st.object

```

##NHL13
```{r, fig.width = 10, fig.height=20}
DefaultAssay(lableaf062) <- "RNA"
lableaf062$NHL13 <- log10(lableaf062@assays$RNA@counts["AT2G27080", ] +1) 


tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableaf5050_log10_NFL13.tiff", width = 4000, height = 4000, res = 300)
plot <- FeatureOverlay(object = lableaf062,
               features = "NHL13",
               spots = rownames(subset(lableaf062[[]],lableaf062@assays$RNA@counts["AT2G27080",] >= 1)),
               pt.size = 2.2,
               sampleids = 6,
               type = "raw",
               show.sb = T,
               value.scale = c("samplewise"),
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)

print(plot)
dev.off()

tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableafALL_log10_NHL13.tiff", width = 4000, height = 8000, res = 300)
plot <-FeatureOverlay(object = lableaf062,
               features = "NHL13",
               spots = rownames(subset(lableaf062[[]],lableaf062@assays$RNA@counts["AT2G27080",] >= 1)),
               pt.size = 3.5,
               sampleids = 1:8,
               ncols = 2,
               type = "raw",
               show.sb = F,
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 0.8)

print(plot)
dev.off()
```
##PR1
```{r, fig.width = 10, fig.height=20}
DefaultAssay(lableaf062) <- "RNA"
lableaf062$PR1 <- log10(lableaf062@assays$RNA@counts["AT2G14610", ] +1) 


tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableaf5050_log10_PR1.tiff", width = 4000, height = 4000, res = 300)
plot <- FeatureOverlay(object = lableaf062,
               features = "PR1",
               spots = rownames(subset(lableaf062[[]],lableaf062@assays$RNA@counts["AT2G14610",] >= 1)),
               pt.size = 2.2,
               sampleids = 6,
               type = "raw",
               show.sb = T,
               value.scale = c("samplewise"),
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)

print(plot)
dev.off()

tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableafALL_log10_PR1.tiff", width = 4000, height = 8000, res = 300)
plot <-FeatureOverlay(object = lableaf062,
               features = "PR1",
               spots = rownames(subset(lableaf062[[]],lableaf062@assays$RNA@counts["AT2G14610",] >= 1)),
               pt.size = 3.5,
               sampleids = 1:8,
               ncols = 2,
               type = "raw",
               show.sb = F,
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)
print(plot)
dev.off()
```

##BAK1
```{r, fig.width = 10, fig.height=20}
DefaultAssay(lableaf062) <- "RNA"
lableaf062$BAK1 <- log10(lableaf062@assays$RNA@counts["AT4G33430", ] +1) 


tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableaf5050_log10_BAK1.tiff", width = 4000, height = 4000, res = 300)
plot <- FeatureOverlay(object = lableaf062,
               features = "BAK1",
               spots = rownames(subset(lableaf062[[]],lableaf062@assays$RNA@counts["AT4G33430",] >= 1)),
               pt.size = 2.2,
               sampleids = 6,
               type = "raw",
               show.sb = T,
               value.scale = c("samplewise"),
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)

print(plot)
dev.off()

tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableafALL_log10_BAK1.tiff", width = 4000, height = 8000, res = 300)
plot <-FeatureOverlay(object = lableaf062,
               features = "BAK1",
               spots = rownames(subset(lableaf062[[]],lableaf062@assays$RNA@counts["AT4G33430",] >= 1)),
               pt.size = 3.5,
               sampleids = 1:8,
               ncols = 2,
               type = "raw",
               show.sb = F,
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)
print(plot)
dev.off()
```
                                  
##FLS2
```{r, fig.width = 10, fig.height=20}
DefaultAssay(lableaf062) <- "RNA"
lableaf062$FLS2 <- log10(lableaf062@assays$RNA@counts["AT5G46330", ] +1) 


tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableaf5050_log10_FLS2.tiff", width = 4000, height = 4000, res = 300)
plot <- FeatureOverlay(object = lableaf062,
               features = "FLS2",
               spots = rownames(subset(lableaf062[[]],lableaf062@assays$RNA@counts["AT5G46330",] >= 1)),
               pt.size = 2.2,
               sampleids = 6,
               type = "raw",
               show.sb = T,
               value.scale = c("samplewise"),
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)

print(plot)
dev.off()

tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableafALL_log10_FLS2.tiff", width = 4000, height = 8000, res = 300)
plot <-FeatureOverlay(object = lableaf062,
               features = "FLS2",
               spots = rownames(subset(lableaf062[[]],lableaf062@assays$RNA@counts["AT5G46330",] >= 1)),
               pt.size = 3.5,
               sampleids = 1:8,
               ncols = 2,
               type = "raw",
               show.sb = F,
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)
print(plot)
dev.off()
```
##RPS4
```{r, fig.width = 10, fig.height=20}
DefaultAssay(lableaf062) <- "RNA"
lableaf062$RPS4 <- log10(lableaf062@assays$RNA@counts["AT5G45250", ] +1) 


tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableaf5050_log10_RPS4.tiff", width = 4000, height = 4000, res = 300)
plot <- FeatureOverlay(object = lableaf062,
               features = "RPS4",
               spots = rownames(subset(lableaf062[[]],lableaf062@assays$RNA@counts["AT5G45250",] >= 1)),
               pt.size = 2.2,
               sampleids = 6,
               type = "raw",
               show.sb = T,
               value.scale = c("samplewise"),
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)

print(plot)
dev.off()

tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableafALL_log10_RPS4.tiff", width = 4000, height = 8000, res = 300)
plot <-FeatureOverlay(object = lableaf062,
               features = "RPS4",
               spots = rownames(subset(lableaf062[[]],lableaf062@assays$RNA@counts["AT5G45250",] >= 1)),
               pt.size = 3.5,
               sampleids = 1:8,
               ncols = 2,
               type = "raw",
               show.sb = F,
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)
print(plot)
dev.off()
```
##Pseudomonas
```{r, fig.width = 10, fig.height=20}
DefaultAssay(lableaf062) <- "BACTERIA"
lableaf062$log.Pseudomonas <- log10(lableaf062@assays$BACTERIA@counts["Pseudomonas", ] +1) 


tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableaf5050_log10_Pseudomonas.tiff", width = 4000, height = 4000, res = 300)
plot <- FeatureOverlay(object = lableaf062,
               features = "log.Pseudomonas",
               spots = rownames(subset(lableaf062[[]],lableaf062@assays$BACTERIA@counts["Pseudomonas",] >= 1)),
               pt.size = 2.2,
               sampleids = 6,
               type = "raw",
               show.sb = T,
               value.scale = c("samplewise"),
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)

print(plot)
dev.off()

tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableafALL_log10_Pseudomonas.tiff", width = 4000, height = 8000, res = 300)
plot <-FeatureOverlay(object = lableaf062,
               features = "log.Pseudomonas",
               spots = rownames(subset(lableaf062[[]],lableaf062@assays$BACTERIA@counts["Pseudomonas",] >= 1)),
               pt.size = 3.5,
               sampleids = 1:8,
               ncols = 2,
               type = "raw",
               show.sb = F,
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)
print(plot)
dev.off()
```
##All data modalities
###RNABAC nCount
```{r, fig.width = 10, fig.height=20}
DefaultAssay(lableaf062) <- "BACTERIA"
lableaf062$log.nCount_RNABAC <- log10(lableaf062[["nCount_RNABAC"]] +1) 


tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableaf5050_log10_nCount_RNABAC.tiff", width = 4000, height = 4000, res = 300)
plot <- FeatureOverlay(object = lableaf062,
               features = "log.nCount_RNABAC",
               pt.size = 2.2,
               sampleids = 6,
               type = "raw",
               show.sb = T,
               value.scale = c("samplewise"),
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)

print(plot)
dev.off()

tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableafALL_log10_nCount_RNABAC.tiff", width = 4000, height = 8000, res = 300)
plot <-FeatureOverlay(object = lableaf062,
               features = "log.nCount_RNABAC",
               pt.size = 3.5,
               sampleids = 1:8,
               ncols = 2,
               type = "raw",
               show.sb = F,
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)
print(plot)
dev.off()
```
###RNA nCount
```{r, fig.width = 10, fig.height=20}
DefaultAssay(lableaf062) <- "RNA"
lableaf062$log.nCount_RNA <- log10(lableaf062[["nCount_RNA"]] +1) 


tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableaf5050_log10_nCount_RNA.tiff", width = 4000, height = 4000, res = 300)
plot <- FeatureOverlay(object = lableaf062,
               features = "log.nCount_RNA",
               pt.size = 2.2,
               sampleids = 6,
               type = "raw",
               show.sb = T,
               value.scale = c("samplewise"),
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)

print(plot)
dev.off()

tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableafALL_log10_nCount_RNA.tiff", width = 4000, height = 8000, res = 300)
plot <-FeatureOverlay(object = lableaf062,
               features = "log.nCount_RNA",
               pt.size = 3.5,
               sampleids = 1:8,
               ncols = 2,
               type = "raw",
               show.sb = F,
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)
print(plot)
dev.off()
```

###BAC nCount
```{r, fig.width = 10, fig.height=20}
DefaultAssay(lableaf062) <- "BACTERIA"
lableaf062$log.nCount_BAC <- log10(lableaf062[["nCount_BACTERIA"]] +1) 


tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableaf5050_log10_nCount_BAC.tiff", width = 4000, height = 4000, res = 300)
plot <- FeatureOverlay(object = lableaf062,
               features = "log.nCount_BAC",
               pt.size = 2.2,
               sampleids = 6,
               type = "raw",
               show.sb = T,
               value.scale = c("samplewise"),
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)

print(plot)
dev.off()

tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableafALL_log10_nCount_BAC.tiff", width = 4000, height = 8000, res = 300)
plot <-FeatureOverlay(object = lableaf062,
               features = "log.nCount_BAC",
               pt.size = 3.5,
               sampleids = 1:8,
               ncols = 2,
               type = "raw",
               show.sb = F,
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)
print(plot)
dev.off()
```


###RNABAC nFeature
```{r, fig.width = 10, fig.height=20}
DefaultAssay(lableaf062) <- "BACTERIA"
lableaf062$log.nFeature_RNABAC <- log10(lableaf062[["nFeature_RNABAC"]] +1) 


tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableaf5050_log10_nFeature_RNABAC.tiff", width = 4000, height = 4000, res = 300)
plot <- FeatureOverlay(object = lableaf062,
               features = "log.nFeature_RNABAC",
               pt.size = 2.2,
               sampleids = 6,
               type = "raw",
               show.sb = T,
               value.scale = c("samplewise"),
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)

print(plot)
dev.off()

tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableafALL_log10_nFeature_RNABAC.tiff", width = 4000, height = 8000, res = 300)
plot <-FeatureOverlay(object = lableaf062,
               features = "log.nFeature_RNABAC",
               pt.size = 3.5,
               sampleids = 1:8,
               ncols = 2,
               type = "raw",
               show.sb = F,
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)
print(plot)
dev.off()
```
###RNA nFeature
```{r, fig.width = 10, fig.height=20}
DefaultAssay(lableaf062) <- "RNA"
lableaf062$log.nFeature_RNA <- log10(lableaf062[["nFeature_RNA"]] +1) 


tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableaf5050_log10_nFeature_RNA.tiff", width = 4000, height = 4000, res = 300)
plot <- FeatureOverlay(object = lableaf062,
               features = "log.nFeature_RNA",
               pt.size = 2.2,
               sampleids = 6,
               type = "raw",
               show.sb = T,
               value.scale = c("samplewise"),
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)

print(plot)
dev.off()

tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableafALL_log10_nFeature_RNA.tiff", width = 4000, height = 8000, res = 300)
plot <-FeatureOverlay(object = lableaf062,
               features = "log.nFeature_RNA",
               pt.size = 3.5,
               sampleids = 1:8,
               ncols = 2,
               type = "raw",
               show.sb = F,
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)
print(plot)
dev.off()
```

###BAC nFeature
```{r, fig.width = 10, fig.height=20}
DefaultAssay(lableaf062) <- "BACTERIA"
lableaf062$log.nFeature_BAC <- log10(lableaf062[["nFeature_BACTERIA"]] +1) 


tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableaf5050_log10_nFeature_BAC.tiff", width = 4000, height = 4000, res = 300)
plot <- FeatureOverlay(object = lableaf062,
               features = "log.nFeature_BAC",
               pt.size = 2.2,
               sampleids = 6,
               type = "raw",
               show.sb = T,
               value.scale = c("samplewise"),
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)

print(plot)
dev.off()

tiff(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210926_lableafALL_log10_nFeature_BAC.tiff", width = 4000, height = 8000, res = 300)
plot <-FeatureOverlay(object = lableaf062,
               features = "log.nFeature_BAC",
               pt.size = 3.5,
               sampleids = 1:8,
               ncols = 2,
               type = "raw",
               show.sb = F,
               cols =  c("#fffce8", "#B8B42D", "#B8B42D", "3e363f", "3e363f", "697a21", "697a21"),
               pt.alpha = 1)
print(plot)
dev.off()
```
    
#Stats from section 6
```{r}
lableaf062_section6 <- SubsetSTData(lableaf062, spots = colnames(lableaf062)[lableaf062$sample_id == infoTable$sample_id[6]])

DefaultAssay(lableaf062_section6) <- "RNA"
keep.host <- rownames(lableaf062_section6[rowSums(lableaf062_section6) >20,])
length(keep.host)

DefaultAssay(lableaf062_section6) <- "BACTERIA"
keep.bacteria <- rownames(lableaf062_section6[rowSums(lableaf062_section6) >10,])
length(keep.bacteria)

d0 <- VlnPlot(lableaf062_section6, features = "nCount_RNA", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d2 <- VlnPlot(lableaf062_section6, features = "nFeature_RNA", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d3<- VlnPlot(lableaf062_section6, features = "percent.mito", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d4 <- VlnPlot(lableaf062_section6, features = "percent.chloro", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d5 <- VlnPlot(lableaf062_section6, features = "percent.ribo", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d6 <- VlnPlot(lableaf062_section6, features = "nCount_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d7 <- VlnPlot(lableaf062_section6, features = "nFeature_BACTERIA", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d8 <- VlnPlot(lableaf062_section6, features = "nCount_RNABAC", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")
d9 <- VlnPlot(lableaf062_section6, features = "nFeature_RNABAC", ncol = 1, pt.size = 0.005, group.by = "sample_id") + xlab("Sample")

pdf(file = "/home/st-analysis_home/sami.saarenpaa/runs/Arabidopsis/201002_191028-062/R_analysis/210925_lableaf_stats_Sample6.pdf", width = 18, height = 15, useDingbats = F)
plot <- plot_grid(d0,d2,d3,d4,d5,d6,d7,d8,d9, nrow = 3)
print(plot)
dev.off()

DefaultAssay(lableaf062_section6) <- "RNA"
ff <- as.numeric(rowSums(lableaf062_section6[rowSums(lableaf062_section6) >20,]))

Reduce(`+`, ff)


DefaultAssay(lableaf062_section6) <- "BACTERIA"
fb <- as.numeric(rowSums(lableaf062_section6[rowSums(lableaf062_section6) >10,]))

Reduce(`+`, fb)

```


                                  